<!-- ===== change-password modal (insert anywhere inside <body>) ===== -->
<!-- Trigger (Ù…Ø«Ù„Ø§Ù‹ Ø¯Ø± Ù…Ù†Ùˆ ÛŒØ§ Ù¾Ø±ÙˆÙØ§ÛŒÙ„) -->
<button id="openChangePwd" class="btn" style="min-width:100px;padding:8px;margin:8px">ğŸ”’ ØªØºÛŒÛŒØ± Ø±Ù…Ø²</button>

<!-- Modal backdrop -->
<div id="changePwdModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:1200;align-items:center;justify-content:center;padding:18px;">
  <div style="width:100%;max-width:420px;background:#fff;border-radius:12px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,0.2);direction:rtl;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <h3 style="margin:0;font-size:16px">ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</h3>
      <button id="closeChangePwd" aria-label="Ø¨Ø³ØªÙ†" style="background:none;border:none;font-size:20px;cursor:pointer">âœ•</button>
    </div>

    <form id="changePwdForm" autocomplete="off" novalidate>
      <div style="display:flex;flex-direction:column;gap:10px">
        <!-- current -->
        <label style="font-size:13px">Ø±Ù…Ø² ÙØ¹Ù„ÛŒ
          <div style="position:relative">
            <input id="currentPwd" type="password" required style="width:100%;padding:10px;border-radius:8px;border:1px solid #ddd" />
            <button type="button" class="togglePwd" data-target="currentPwd" style="position:absolute;left:8px;top:8px;background:none;border:none;cursor:pointer">ğŸ‘ï¸</button>
          </div>
        </label>

        <!-- new -->
        <label style="font-size:13px">Ø±Ù…Ø² Ø¬Ø¯ÛŒØ¯
          <div style="position:relative">
            <input id="newPwd" type="password" required minlength="8" style="width:100%;padding:10px;border-radius:8px;border:1px solid #ddd" />
            <button type="button" class="togglePwd" data-target="newPwd" style="position:absolute;left:8px;top:8px;background:none;border:none;cursor:pointer">ğŸ‘ï¸</button>
          </div>
        </label>

        <!-- confirm -->
        <label style="font-size:13px">ØªÚ©Ø±Ø§Ø± Ø±Ù…Ø² Ø¬Ø¯ÛŒØ¯
          <div style="position:relative">
            <input id="confirmPwd" type="password" required style="width:100%;padding:10px;border-radius:8px;border:1px solid #ddd" />
            <button type="button" class="togglePwd" data-target="confirmPwd" style="position:absolute;left:8px;top:8px;background:none;border:none;cursor:pointer">ğŸ‘ï¸</button>
          </div>
        </label>

        <!-- password strength -->
        <div id="pwdStrength" style="height:8px;background:#eee;border-radius:6px;overflow:hidden">
          <div id="pwdStrengthBar" style="height:100%;width:0%;background:#ddd;transition:width .2s"></div>
        </div>
        <div id="pwdCriteria" style="font-size:12px;color:#666;display:flex;flex-direction:column;gap:4px">
          <div id="cLen">â€¢ Ø­Ø¯Ø§Ù‚Ù„ Û¸ Ú©Ø§Ø±Ø§Ú©ØªØ±</div>
          <div id="cUpper">â€¢ ÛŒÚ© Ø­Ø±Ù Ø¨Ø²Ø±Ú¯</div>
          <div id="cNumber">â€¢ ÛŒÚ© Ø¹Ø¯Ø¯</div>
          <div id="cSpecial">â€¢ ÛŒÚ© Ú©Ø§Ø±Ø§Ú©ØªØ± ÙˆÛŒÚ˜Ù‡ (Ù…Ø«Ù„Ø§Ù‹ !@#)</div>
        </div>

        <!-- feedback -->
        <div id="changeMsg" role="status" style="min-height:20px;font-size:13px;color:#b33"></div>

        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:4px;">
          <button type="button" id="cancelChangePwd" style="background:#f3f3f3;border:1px solid #ddd;padding:8px 12px;border-radius:8px;cursor:pointer">Ø§Ù†ØµØ±Ø§Ù</button>
          <button type="submit" id="submitChangePwd" style="background:var(--color-primary, #00BCD4);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer">Ø«Ø¨Øª ØªØºÛŒÛŒØ±</button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
/* ===== change-password logic (client-side simulation) ===== */
(function(){
  const openBtn = document.getElementById('openChangePwd');
  const modal = document.getElementById('changePwdModal');
  const closeBtn = document.getElementById('closeChangePwd');
  const cancelBtn = document.getElementById('cancelChangePwd');
  const form = document.getElementById('changePwdForm');
  const cur = document.getElementById('currentPwd');
  const neu = document.getElementById('newPwd');
  const conf = document.getElementById('confirmPwd');
  const msg = document.getElementById('changeMsg');
  const bar = document.getElementById('pwdStrengthBar');
  const cLen = document.getElementById('cLen');
  const cUpper = document.getElementById('cUpper');
  const cNumber = document.getElementById('cNumber');
  const cSpecial = document.getElementById('cSpecial');

  // open / close
  openBtn.addEventListener('click', ()=> { modal.style.display='flex'; msg.textContent=''; form.reset(); updateStrength(); });
  closeBtn.addEventListener('click', ()=> modal.style.display='none');
  cancelBtn.addEventListener('click', ()=> modal.style.display='none');
  modal.addEventListener('click', (e)=> { if(e.target===modal) modal.style.display='none'; });

  // toggle visibility
  document.querySelectorAll('.togglePwd').forEach(btn=>{
    btn.addEventListener('click', (ev)=>{
      const target = document.getElementById(btn.dataset.target);
      if(target.type==='password'){ target.type='text'; btn.textContent='ğŸ™ˆ'; }
      else { target.type='password'; btn.textContent='ğŸ‘ï¸'; }
    });
  });

  // password strength check
  function checkStrength(p){
    const rules = {
      len: p.length>=8,
      upper: /[A-Z\u0600-\u06FF]/.test(p) && /[A-Z]/.test(p) || /[Ø¢-ÛŒ]/.test(p), // accept persian letters or latin uppercase as "letter"
      num: /\d/.test(p),
      special: /[!@#\$%\^&\*\(\)\-_\+=\[\]\{\};:'"\\|,.<>\/?]/.test(p)
    };
    return rules;
  }
  function updateStrength(){
    const p = neu.value || '';
    const r = checkStrength(p);
    const score = (r.len + r.upper + r.num + r.special) / 4;
    bar.style.width = `${Math.round(score*100)}%`;
    bar.style.background = score<=0.25 ? '#e74c3c' : score<=0.5 ? '#f39c12' : score<=0.75 ? '#27ae60' : '#00897b';
    cLen.style.color = r.len ? '#00897b' : '#666';
    cUpper.style.color = r.upper ? '#00897b' : '#666';
    cNumber.style.color = r.num ? '#00897b' : '#666';
    cSpecial.style.color = r.special ? '#00897b' : '#666';
  }
  neu.addEventListener('input', updateStrength);

  // submit (simulate API)
  form.addEventListener('submit', (e)=>{
    e.preventDefault();
    msg.style.color = '#b33';
    msg.textContent = '';

    const current = cur.value.trim();
    const newp = neu.value.trim();
    const confp = conf.value.trim();

    if(!current || !newp || !confp){ msg.textContent = 'Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ ØªÚ©Ù…ÛŒÙ„ Ú©Ù†ÛŒØ¯.'; return; }
    if(newp !== confp){ msg.textContent = 'Ø±Ù…Ø² Ø¬Ø¯ÛŒØ¯ Ùˆ ØªÚ©Ø±Ø§Ø± Ø¢Ù† Ø¨Ø±Ø§Ø¨Ø± Ù†ÛŒØ³ØªÙ†Ø¯.'; return; }

    const rules = checkStrength(newp);
    if(!(rules.len && rules.num && rules.special && rules.upper)){
      msg.textContent = 'Ø±Ù…Ø² Ø¬Ø¯ÛŒØ¯ Ø´Ø±Ø§ÛŒØ· Ø§Ù…Ù†ÛŒØªÛŒ Ø±Ø§ Ù†Ø¯Ø§Ø±Ø¯. Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ Ø±Ø§ Ø±Ø¹Ø§ÛŒØª Ú©Ù†ÛŒØ¯.';
      return;
    }

    // disable UI
    const submitBtn = document.getElementById('submitChangePwd');
    submitBtn.disabled = true; submitBtn.style.opacity = '0.6'; msg.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª...';

    // SIMULATION: Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ø§ÛŒØ¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ API Ø§Ø±Ø³Ø§Ù„ Ø´ÙˆØ¯ (HTTPS, POST, Ø¨Ø§ ØªÙˆÚ©Ù† Ú©Ø§Ø±Ø¨Ø±)
    // Ù…Ø«Ø§Ù„: fetch('/api/change-password', {method:'POST', headers:{Authorization:'Bearer ...'}, body: JSON.stringify({current, new: newp})})
    setTimeout(()=>{
      // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ù¾Ø§Ø³Ø® Ù…ÙˆÙÙ‚/Ù†Ø§Ù…ÙˆÙÙ‚
      const serverOk = (current === 'current_pass_example'); // Ø¨Ø±Ø§ÛŒ Ù†Ù…ÙˆÙ†Ù‡ ÙØ±Ø¶ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… current_pass_example Ø±Ù…Ø² ÙØ¹Ù„ÛŒ Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª
      if(!serverOk){
        msg.style.color = '#b33';
        msg.textContent = 'Ø±Ù…Ø² ÙØ¹Ù„ÛŒ Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª.';
        submitBtn.disabled = false; submitBtn.style.opacity = '1';
        return;
      }
      // Ù…ÙˆÙÙ‚
      msg.style.color = '#0a7';
      msg.textContent = 'Ø±Ù…Ø² Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØºÛŒÛŒØ± Ú©Ø±Ø¯.';
      setTimeout(()=>{ modal.style.display='none'; submitBtn.disabled = false; submitBtn.style.opacity = '1'; }, 900);
    }, 1200);
  });

  // accessibility: submit on Enter inside confirm
  conf.addEventListener('keydown', (e)=>{ if(e.key==='Enter') form.dispatchEvent(new Event('submit')); });

  // init
  updateStrength();
})();
</script>
